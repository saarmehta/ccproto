<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="mdb-utils.html">
<dom-module id="mdb-gsheet-data-adapter">
    <template>
        <google-sheets key="[[key]]" tab-id="[[tabId]]" published></google-sheets>
    </template>
    <script>
        Polymer({
            is: 'mdb-gsheet-data-adapter',

            behaviors: [Mdb.Utils],

            properties: {
                key: String,

                data: {
                    type: Array
                }
            },

            attached: function () {
                var that = this;
                var sheet = this.querySelector('google-sheets');
                sheet.addEventListener('google-sheet-data', function (e) {
                    that.data = that._parseSheet(this.rows);
                });
            },

            getLOBs: function () {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: that._getBasePath() + 'data/lobs.json'
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            getLOBConcepts: function (lob) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/concepts.json').toLowerCase()
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            getConceptApplications: function (lob, concept) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept._id + '/applications.json').toLowerCase()
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            getApplicationDBs: function (lob, concept, application) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept._id + '/applications/' + application._id + '/databases.json').toLowerCase()
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            getDBSchemas: function (lob, concept, application, db) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept._id + '/applications/' + application._id + '/databases/' + db._id + '/schemas.json').toLowerCase()
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            getSchemaTables: function (lob, concept, application, db, schema) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept._id + '/applications/' + application._id + '/databases/' + db._id + '/schemas/' + schema._id + '/tables.json').toLowerCase()
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            getTableData: function (lob, concept, application, db, schema, table) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    var p1 = that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept._id + '/applications/' + application._id + '/databases/' + db._id + '/schemas/' + schema._id + '/tables/' + table._id + '/columns.json').toLowerCase()
                    });
                    var p2 = that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept._id + '/applications/' + application._id + '/databases/' + db._id + '/schemas/' + schema._id + '/tables/' + table._id + '/data.json').toLowerCase()
                    });

                    Promise.all([p1, p2]).then(function (values) {
                        resolve({
                            columns: JSON.parse(values[0].response),
                            rows: JSON.parse(values[1].response)
                        });
                    });
                });
            },

            getRecommendedConcepts: function (lob, concept, application, db, schema, table, column) {
                var that = this;
                return new Promise(function (resolve, reject) {
                    that._makeRequest({
                        url: (that._getBasePath() + 'data/lobs/' + lob + '/' + concept + '/applications/' + application + '/databases/' + db + '/schemas/' + schema + '/tables/' + table + '/recommended-concepts.json').toLowerCase()
                    }).then(function (e) {
                        resolve(JSON.parse(e.response));
                    });
                });
            },

            _parseSheet: function () {

            }
        });
    </script>
</dom-module>